# NBA Comeback Calculator - Development Guide

## Project Overview

The NBA Comeback Calculator analyzes NBA game data to determine the probability of successful comebacks based on point deficit, time remaining, team ranking, and home/away status. The project consists of two main components:

1. **Python Data Pipeline**: Downloads and processes NBA game data, performs statistical analysis, and generates JSON data files
2. **JavaScript Frontend**: Visualizes the data using Chart.js in a Sphinx-based documentation site

The site is published at: [nba-comeback-calculator.github.io](https://nba-comeback-calculator.github.io)

## Repository Structure

- **Python Backend**: Located in `/nba_comeback_calculator/`
  - `form_json_season_data/`: Data acquisition and processing
    - `form_nba_game_sqlite_database.py`: Downloads and stores NBA data in SQLite
    - `form_nba_game_json_seasons.py`: Converts SQLite to season JSON files
  - `form_json_chart_data/`: Chart data generation and analysis
    - `form_nba_chart_json_data_api/`: Core library for analysis
      - `form_nba_chart_json_data_api.py`: Main API for chart generation
      - `form_nba_chart_json_data_num.py`: Statistical calculations (probit regression)
      - `form_nba_chart_json_data_plot_primitives.py`: Chart data structures
      - `form_nba_chart_json_data_season_game_loader.py`: Loads game data
    - `form_nba_chart_json_data_for_sphinx_pages/`: Scripts that generate specific chart JSON files
      - `plot_nba_game_data_analysis_20_18.py`: 2018-20 analysis
      - `plot_nba_game_data_analysis_create_plots_page.py`: Creates chart data for all Sphinx pages
      - `plot_nba_game_data_analysis_thumb.py`: Creates thumbnails

- **JavaScript Frontend**: Located in `/docs/frontend/source/_static/`
  - `js/`: Frontend JavaScript modules
  - `css/`: Styling files
  - `json/`: Chart and season data files

- **Documentation**:
  - `docs/frontend/`: Sphinx project for the public-facing website/app
  - `docs/developer/`: (Future) Developer documentation for the codebase

## Data Flow

1. `form_nba_game_sqlite_database.py` downloads play-by-play data from stats.nba.com and creates a SQLite database
2. `form_nba_game_json_seasons.py` extracts point_margin and other game data from SQLite and stores as JSON season files
3. The modules in `form_json_chart_data/` process the JSON season data to create chart-specific JSON files:
   - `form_nba_chart_json_data_api/` contains the library code for analysis
   - `form_nba_chart_json_data_for_sphinx_pages/` contains the scripts that use the library to generate chart JSON
4. JavaScript frontend consumes these JSON files for visualization with Chart.js

## Key Concepts

### Game Filtering

The `GameFilter` class is central to the analysis, allowing filtering by:

- `for_at_home`: Boolean for home/away games
- `for_rank`: Team ranking ("top_5", "top_10", "mid_10", "bot_10", "bot_5")
- `for_team_abbr`: Team abbreviation(s)
- `vs_rank`: Opponent ranking
- `vs_team_abbr`: Opponent abbreviation(s)

Important constraints:
- Cannot specify both `for_rank` and `for_team_abbr` at the same time
- Cannot specify both `vs_rank` and `vs_team_abbr` at the same time

### Chart Types

Two primary chart types:
1. **Point Margin vs Win Percent**: Shows win probability based on point deficit
   - Generated by `plot_biggest_deficit()` function
   - Can analyze specific times or ranges (halftime, 4th quarter, etc.)
   - Can cumulate point deficits ("or more" analysis)

2. **Time vs Point Margin**: Shows probability over time
   - Generated by `plot_percent_versus_time()` function
   - Shows how deficit needed for particular win probability changes over time
   - Can compare to theoretical models (âˆšt relationship)

### Key Classes

- **Season**: Loads data for a specific NBA season from JSON files
- **Games**: Collects game data across multiple seasons with optional filtering
- **PlotLine**: Base class for all chart lines
  - **PointsDownLine**: For analyzing win probability based on point deficit
  - **PercentLine**: For analyzing win probability over time
- **FinalPlot**: Represents a complete chart with all its lines and metadata

### Mathematical Foundation

- Uses probit regression to model win probability
- Standard normal distribution for probabilities
- Optimization using numeric.js (or scipy in Python)
- The relationship between deficit and time follows approximately a square root curve

## JavaScript Frontend

The JavaScript frontend consists of several modules:

- **Chart Rendering**: `nbacc_plotter_*.js` files handle chart rendering using Chart.js
- **Calculator**: `nbacc_calculator_*.js` files provide the interactive calculator functionality
- **Utilities**: `nbacc_utils.js` contains common utility functions
- **Chart Loader**: `nbacc_chart_loader.js` initializes and loads charts

Key features include:
- Interactive zooming and panning
- Full-screen mode
- Export to PNG
- Interactive calculator with filtering options

## Development Guidelines

### Python Code Style
- Use Python 3.8+
- Follow PEP 8 guidelines
- Use docstrings for functions and classes

### JavaScript Code Style
- Namespace modules with `nbacc_` prefix
- Use IIFE pattern for modules
- 4-space indentation, trailing semicolons
- Naming: camelCase for variables/functions

### Documentation Structure
- `docs/frontend/`: The Sphinx documentation project for the public-facing website
- `docs/developer/`: (Future) Developer documentation for the codebase

## Main Functions

### plot_biggest_deficit
Analyzes win probability based on point deficit at different game times.
- Accepts a list of `game_filters` for filtering games
- Creates combinations of year groups and filters
- Adds filter descriptions to titles and legends for better clarity

### plot_percent_versus_time
Analyzes how win probability changes throughout the game.
- Accepts a list of `game_filters` for filtering games
- Can plot guide lines showing the square root of time relationship